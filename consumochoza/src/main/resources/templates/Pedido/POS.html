<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{Masterplantilla/Master}">

<head>
    <title>Punto de Venta</title>
 
</head>

<body>
    <div layout:fragment="contenidopaginas">
        <!-- Mensajes de error/éxito -->
        <div id="alertError" class="alert alert-danger alert-dismissible fade show" role="alert"
             th:attr="style=${error} ? '' : 'display:none;'">
            <i class="bi bi-exclamation-triangle-fill"></i>
            <span id="alertErrorText" th:text="${error}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        <div th:if="${exito}" class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle-fill"></i> <span th:text="${exito}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        <!-- Cabecera moderna POS -->
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-3">
            <div>
                <h1 class="page-title mb-1"><i class="bi bi-shop-window me-2"></i>Punto de Venta</h1>
            </div>
            <div class="d-flex align-items-center gap-3 mt-2 mt-md-0">
                <div class="stats-badge d-flex align-items-center gap-2" id="badgeVentasHoy" title="Ventas de hoy">
                    <i class="bi bi-cash-stack"></i>
                    <span class="fw-semibold" id="ventasHoyTexto">$0.00</span>
                    <small class="text-muted" id="pedidosHoyTexto">(0 pedidos)</small>
                </div>
                
            </div>
        </div>

        <form th:action="@{/pedidos/guardar}" method="post" id="pedidoForm" onsubmit="return validarYEnviarPedido(event)" novalidate>
             <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                 <input type="hidden" name="idpedido" th:value="${pedido.idpedido}" />
                 <input type="hidden" name="estado" value="PENDIENTE" />
                 <input type="hidden" name="idUsuario" id="idUsuario"
                     th:value="${pedido.idUsuario != null ? pedido.idUsuario : (usuarioLogueado != null ? usuarioLogueado.idusuario : '')}" />
            
            <div class="row g-3">
                <!-- Columna izquierda: Pedido actual -->
                <div class="col-lg-3 order-lg-1 order-2">
                    <div class="card carrito-card sticky-top" style="top: 80px;">
                        <div class="card-header bg-primary text-white py-2">
                            <h5 class="mb-0 d-flex justify-content-between align-items-center flex-wrap gap-2">
                                <div>
                                    <span class="d-block"><i class="bi bi-receipt-cutoff me-1"></i>Pedido actual</span>
                                    <small class="text-dark fw-semibold" id="resumenMesaCliente">Sin mesa / sin cliente</small>
                                </div>
                                <span class="badge bg-light text-primary" id="badgeItems">0 ítems</span>
                            </h5>
                        </div>
                        <div class="card-body p-0">
                            <!-- Lista de productos en el carrito -->
                            <div class="carrito-items" id="carritoItems">
                                <div class="carrito-vacio" id="carritoVacio">
                                    <i class="bi bi-cart-x"></i>
                                    <p>Carrito vacío</p>
                                    <small>Haz clic en un producto para agregarlo</small>
                                </div>
                            </div>
                            <!-- Contenedor oculto para los inputs del form -->
                            <div id="detallesHidden" style="display: none;"></div>
                        </div>
                        <div class="card-footer">
                            <!-- Total -->
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <span class="fs-5 fw-bold">TOTAL:</span>
                                <span class="fs-4 fw-bold text-primary" id="totalPedido">$0.00</span>
                            </div>

                            <!-- (Se retiró el teclado numérico de cantidad rápida y las acciones rápidas para simplificar la vista) -->
                            <!-- Observaciones -->
                            <div class="mb-3">
                                <textarea class="form-control form-control-sm" name="observaciones" 
                                          placeholder="Observaciones..." rows="2" th:text="${pedido.observaciones}"></textarea>
                            </div>
                            <!-- Botones de acción -->
                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-success btn-lg" id="btnGuardar" disabled>
                                    <i class="bi bi-check-circle"></i> Confirmar Pedido
                                </button>
                                <div class="btn-group mt-1">
                                    <button type="button" class="btn btn-outline-danger" onclick="limpiarCarrito()">
                                        <i class="bi bi-trash"></i> Limpiar
                                    </button>
                                    <a th:href="@{/pedidos}" class="btn btn-outline-secondary">
                                        <i class="bi bi-x-circle"></i> Cancelar
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Columna central: catálogo de productos -->
                <div class="col-lg-5 order-lg-2 order-1">
                    <div class="card mb-3" style="overflow: visible;">
                        <div class="card-body py-2" style="overflow: visible;">
                            <div class="d-flex flex-column flex-md-row align-items-md-center gap-2">
                                <div class="flex-grow-1">
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                                        <input type="text" class="form-control" id="busquedaProducto"
                                               placeholder="Buscar producto..." autocomplete="off" />
                                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="refrescarStock()" title="Refrescar stock">
                                            <i class="bi bi-arrow-clockwise"></i>
                                        </button>
                                    </div>
                                    <small class="text-muted d-block mt-1">
                                        Atendido por:
                                        <span th:text="${pedido.usuario != null ? pedido.usuario.nombreCompleto : (usuarioLogueado != null ? usuarioLogueado.nombreCompleto : 'Sin usuario')}"></span>
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Filtro por categoría -->
                    <div class="categoria-tabs mb-3">
                        <button type="button" class="btn btn-categoria active" data-categoria="todos">
                            <i class="bi bi-grid-3x3-gap"></i> Todos
                        </button>
                        <button type="button" th:each="cat : ${categorias}" 
                                class="btn btn-categoria" 
                                th:data-categoria="${cat.idcategoria}"
                                th:text="${cat.nombre}">
                        </button>
                    </div>

                    <!-- Grid de productos -->
                    <div class="productos-grid" id="productosGrid">
                        <div th:each="prod : ${productos}" 
                             class="producto-card"
                             th:classappend="${prod.stockActual == null || prod.stockActual == 0 ? 'producto-agotado' : (prod.stockActual <= 5 ? 'producto-stock-bajo' : '')}"
                             th:data-categoria="${prod.categoriaId}"
                             th:data-id="${prod.idproducto}"
                             th:data-nombre="${prod.nombre}"
                             th:data-precio="${prod.precio}"
                             th:data-stock="${prod.stockActual != null ? prod.stockActual : 0}"
                             onclick="agregarAlCarrito(this)">
                            <div class="producto-img">
                                <img th:if="${prod.imagenUrl != null && !prod.imagenUrl.isEmpty()}" 
                                     th:src="${prod.imagenUrl}" 
                                     th:alt="${prod.nombre}" />
                                <i th:if="${prod.imagenUrl == null || prod.imagenUrl.isEmpty()}" 
                                   class="bi bi-box-seam"></i>
                                <span th:if="${prod.stockActual == null || prod.stockActual == 0}" class="badge bg-danger position-absolute top-0 start-0 m-1">AGOTADO</span>
                                <span th:if="${prod.stockActual != null && prod.stockActual > 0 && prod.stockActual <= 5}" class="badge bg-warning position-absolute top-0 start-0 m-1" th:text="'Stock: ' + ${prod.stockActual}"></span>
                            </div>
                            <div class="producto-info">
                                <span class="producto-nombre" th:text="${prod.nombre}"></span>
                                <span class="producto-precio" th:text="'$' + ${#numbers.formatDecimal(prod.precio, 1, 2)}"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Columna derecha: mesa, cuenta y cliente -->
                <div class="col-lg-4 order-lg-3 order-3">
                    <div class="card sticky-top" style="top: 80px;">
                        <div class="card-header bg-white border-0 pb-0">
                            <h5 class="mb-0 d-flex align-items-center gap-2">
                                <i class="bi bi-table"></i>
                                <span>Mesa</span>
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-2">
                                <label class="form-label small mb-1">Seleccionar mesa</label>
                                <div class="input-group input-group-sm">
                                    <span class="input-group-text"><i class="bi bi-shop"></i></span>
                                    <select class="form-select" name="idMesa" id="idMesa" required>
                                        <option value="">Mesa</option>
                                        <option th:each="mesa : ${mesas}" 
                                                th:value="${mesa.idmesa}" 
                                                th:text="'Mesa ' + ${mesa.numero}"
                                                th:selected="${pedido.idMesa == mesa.idmesa}"></option>
                                    </select>
                                </div>
                                <small id="infoCuentaMesa" class="text-info fw-bold d-block mt-1"></small>
                            </div>

                            <div class="mb-3">
                                <label class="form-label small mb-1">Cuenta</label>
                                <div class="mt-1">
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="modoCuenta" id="modoCuentaExistente" value="EXISTENTE" checked>
                                        <label class="form-check-label" for="modoCuentaExistente">Usar cuenta abierta</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="modoCuenta" id="modoCuentaNueva" value="NUEVA">
                                        <label class="form-check-label" for="modoCuentaNueva">Crear nueva cuenta</label>
                                    </div>
                                </div>
                                <input type="hidden" name="idCuentaSeleccionada" id="idCuentaSeleccionada" />
                                <div id="cuentasMesaContainer" class="mt-2" style="display:none;">
                                    <div class="card border-info">
                                        <div class="card-body p-2">
                                            <small class="text-muted d-block mb-1">Cuentas abiertas de esta mesa:</small>
                                            <div id="listaCuentasMesa" class="list-group list-group-flush small"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label small mb-1">Cliente</label>
                                <div class="input-group input-group-sm position-relative">
                                    <span class="input-group-text"><i class="bi bi-person-badge"></i></span>
                                    <input type="hidden" name="idCliente" id="idCliente" th:value="${pedido.idCliente}" />
                                    <input type="text" class="form-control" id="clienteBusqueda" 
                                           placeholder="Buscar cliente..." autocomplete="off" />
                                    
                                    <div id="clienteResultados" class="list-group position-absolute shadow" 
                                         style="z-index: 9999; top: 100%; left: 0; right: 0; max-height: 200px; overflow-y: auto; display: none; background: white;"></div>
                                </div>
                                <small id="clienteSeleccionado" class="text-success fw-bold"></small>
                                <button type="button" class="btn btn-warning w-100 mt-2" onclick="abrirModalNuevoCliente()">
                                    <i class="bi bi-person-plus"></i> Nuevo Cliente
                                </button>
                            </div>

                            <hr class="my-3" />

                            <div class="list-group mb-3 small">
                                <button type="button" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" onclick="irAObservaciones()">
                                    <span><i class="bi bi-journal-text me-2"></i>Nota general</span>
                                    <span class="text-muted"><i class="bi bi-chevron-right"></i></span>
                                </button>
                            </div>

                            <small class="text-muted d-block mb-1">Resumen rápido</small>
                            <p class="mb-0 small" id="resumenMesaClienteLateral">Selecciona mesa y cliente para ver el resumen.</p>
                        </div>
                    </div>
                </div>
            </div>
        </form>
        
        <!-- Modal Nuevo Cliente -->
        <div class="modal fade" id="modalNuevoCliente" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title"><i class="bi bi-person-plus"></i> Nuevo Cliente</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Nombre *</label>
                            <input type="text" class="form-control" id="nuevoClienteNombre" required />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Cédula *</label>
                            <input type="text" class="form-control" id="nuevoClienteCedula" maxlength="13" required />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Teléfono</label>
                            <input type="text" class="form-control" id="nuevoClienteTelefono" maxlength="10" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Dirección</label>
                            <input type="text" class="form-control" id="nuevoClienteDireccion" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" id="nuevoClienteEmail" maxlength="150" />
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-primary" onclick="guardarNuevoCliente()">
                            <i class="bi bi-check"></i> Guardar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Pedidos activos por mesa -->
        <div class="modal fade" id="modalPedidosMesa" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-warning text-dark">
                        <h5 class="modal-title"><i class="bi bi-exclamation-triangle"></i> Mesa con pedidos activos</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p class="mb-2">Esta mesa ya tiene pedidos abiertos. Puedes abrir uno existente o continuar creando un nuevo pedido.</p>
                        <div id="listaPedidosMesa"></div>
                    </div>
                    <div class="modal-footer">
                        <a href="/pedidos" class="btn btn-outline-secondary">
                            <i class="bi bi-list"></i> Ver todos los pedidos
                        </a>
                        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
                            <i class="bi bi-plus-circle"></i> Crear nuevo pedido igualmente
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <script th:inline="javascript">
            // URL para consultar cuentas abiertas siempre actualizadas
            const cuentasAbiertasUrl = /*[[@{/api/pos/cuentas/abiertas}]]*/ '/api/pos/cuentas/abiertas';
            // Cuentas abiertas iniciales (fallback)
            let cuentasAbiertas = /*[[${cuentasAbiertas}]]*/ [];
            const productosData = /*[[${productos}]]*/ [];
            // Detalles existentes del pedido (cuando se edita o hay error de validación en el backend)
            const detallesExistentes = /*[[${pedido.detalles}]]*/ [];
            const clientesData = /*[[${clientes}]]*/ [];
            const clienteIdExistente = /*[[${pedido.idCliente}]]*/ null;
            let carrito = [];
            let categoriaSeleccionada = 'todos';
            let terminoProducto = '';
            const csrfToken = document.querySelector('input[name="_csrf"]')?.value || '';

            // Mostrar error en la banda superior del POS (sin usar alert())
            function mostrarErrorPos(mensaje) {
                const alertDiv = document.getElementById('alertError');
                if (!alertDiv) {
                    alert(mensaje);
                    return;
                }
                const span = document.getElementById('alertErrorText') || alertDiv.querySelector('span');
                if (span) {
                    span.textContent = mensaje;
                }
                alertDiv.style.display = '';
                alertDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }

            function actualizarResumenMesaCliente() {
                const label = document.getElementById('resumenMesaCliente');
                const lateral = document.getElementById('resumenMesaClienteLateral');

                const selectMesa = document.getElementById('idMesa');
                const inputCliente = document.getElementById('clienteBusqueda');

                const mesaTexto = selectMesa && selectMesa.value
                    ? ('Mesa ' + selectMesa.options[selectMesa.selectedIndex].text.replace('Mesa', '').trim())
                    : 'Sin mesa';

                const clienteTexto = inputCliente && inputCliente.value
                    ? inputCliente.value
                    : 'Sin cliente';

                const resumen = mesaTexto + ' · ' + clienteTexto;

                if (label) {
                    label.textContent = resumen;
                }
                if (lateral) {
                    lateral.textContent = resumen;
                }
            }

            function marcarCuentaSeleccionada(idCuenta) {
                const lista = document.getElementById('listaCuentasMesa');
                if (!lista) return;
                const items = lista.querySelectorAll('.list-group-item');
                items.forEach(btn => {
                    const btnId = parseInt(btn.getAttribute('data-id') || '0');
                    if (btnId === idCuenta) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });
            }

            function seleccionarCuentaMesa(btn, idCuenta) {
                const inputId = document.getElementById('idCuentaSeleccionada');
                if (inputId) {
                    inputId.value = idCuenta;
                }
                const rbExistente = document.getElementById('modoCuentaExistente');
                const rbNueva = document.getElementById('modoCuentaNueva');
                if (rbExistente) {
                    rbExistente.disabled = false;
                    rbExistente.checked = true;
                }
                if (rbNueva) {
                    rbNueva.checked = false;
                }
                const lista = document.getElementById('listaCuentasMesa');
                if (lista) {
                    lista.querySelectorAll('.list-group-item').forEach(el => el.classList.remove('active'));
                }
                if (btn) {
                    btn.classList.add('active');
                }
            }

            // Actualizar indicador de cuenta según la mesa seleccionada
            function actualizarInfoCuentaMesa() {
                const selectMesa = document.getElementById('idMesa');
                const labelInfo = document.getElementById('infoCuentaMesa');
                const rbExistente = document.getElementById('modoCuentaExistente');
                const rbNueva = document.getElementById('modoCuentaNueva');
                const cuentasContainer = document.getElementById('cuentasMesaContainer');
                const listaCuentasMesa = document.getElementById('listaCuentasMesa');
                const inputIdCuenta = document.getElementById('idCuentaSeleccionada');
                if (!selectMesa || !labelInfo) return;

                const idMesa = parseInt(selectMesa.value || '0');
                if (!idMesa) {
                    labelInfo.textContent = '';
                    if (cuentasContainer) {
                        cuentasContainer.style.display = 'none';
                    }
                    if (listaCuentasMesa) {
                        listaCuentasMesa.innerHTML = '';
                    }
                    if (inputIdCuenta) {
                        inputIdCuenta.value = '';
                    }
                    if (rbExistente) rbExistente.disabled = true;
                    if (rbNueva) {
                        rbNueva.disabled = false;
                        rbNueva.checked = true;
                    }
                    return;
                }

                const cuentasMesa = (cuentasAbiertas || []).filter(c => c.mesa && c.mesa.idmesa === idMesa);
                if (cuentasMesa.length > 0) {
                    const cuenta = cuentasMesa[0];
                    const total = (cuenta.total != null ? cuenta.total.toFixed(2) : '0.00');
                    labelInfo.textContent = `Mesa con ${cuentasMesa.length} cuenta(s) abierta(s). Ej: #${cuenta.idcuenta}, Total $${total}`;
                    labelInfo.classList.remove('text-success');
                    labelInfo.classList.add('text-info');
                    if (rbExistente) {
                        rbExistente.disabled = false;
                        rbExistente.checked = true;
                    }
                    if (rbNueva) rbNueva.disabled = false;

                    if (listaCuentasMesa) {
                        listaCuentasMesa.innerHTML = cuentasMesa.map(c => {
                            const totalCuenta = (c.total != null ? c.total.toFixed(2) : '0.00');
                            const clienteNombre = c.cliente && c.cliente.nombre ? c.cliente.nombre : 'Sin cliente';
                            return `
                                <button type="button" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" data-id="${c.idcuenta}" onclick="seleccionarCuentaMesa(this, ${c.idcuenta})">
                                    <span>#${c.idcuenta} - ${clienteNombre}</span>
                                    <span class="badge bg-primary">$${totalCuenta}</span>
                                </button>
                            `;
                        }).join('');
                    }
                    if (cuentasContainer) {
                        cuentasContainer.style.display = 'block';
                    }
                    if (inputIdCuenta) {
                        let idSeleccion = parseInt(inputIdCuenta.value || '0');
                        if (!idSeleccion && cuentasMesa.length > 0) {
                            idSeleccion = cuentasMesa[0].idcuenta;
                        }
                        if (idSeleccion) {
                            inputIdCuenta.value = idSeleccion;
                            marcarCuentaSeleccionada(idSeleccion);
                        }
                    }
                } else {
                    labelInfo.textContent = 'Sin cuenta abierta: se creará una al confirmar el pedido';
                    labelInfo.classList.remove('text-info');
                    labelInfo.classList.add('text-success');
                    if (cuentasContainer) {
                        cuentasContainer.style.display = 'none';
                    }
                    if (listaCuentasMesa) {
                        listaCuentasMesa.innerHTML = '';
                    }
                    if (inputIdCuenta) {
                        inputIdCuenta.value = '';
                    }
                    if (rbExistente) rbExistente.disabled = true;
                    if (rbNueva) {
                        rbNueva.disabled = false;
                        rbNueva.checked = true;
                    }
                }
            }

            // Recargar cuentas abiertas desde el backend y actualizar indicador
            function recargarCuentasAbiertasYActualizar() {
                fetch(cuentasAbiertasUrl)
                    .then(r => r.ok ? r.json() : [])
                    .then(data => {
                        if (Array.isArray(data)) {
                            cuentasAbiertas = data;
                        }
                        actualizarInfoCuentaMesa();
                    })
                    .catch(err => {
                        console.error('Error al cargar cuentas abiertas', err);
                        actualizarInfoCuentaMesa();
                    });
            }
            
            // Mapa de stock para acceso rápido y seguro
            // Al editar un pedido, sumamos al stock actual la cantidad ya reservada
            // en ese mismo pedido, para que el POS no lo trate como un pedido nuevo.
            const stockMap = {};
            productosData.forEach(p => {
                stockMap[p.idproducto] = (p.stockActual != null && p.stockActual > 0) ? p.stockActual : 0;
            });

            if (detallesExistentes && detallesExistentes.length > 0) {
                detallesExistentes.forEach(det => {
                    const cant = det.cantidad != null ? det.cantidad : 0;
                    if (!cant) return;

                    // Puede venir como det.producto.idproducto (cuando el backend envía el producto completo)
                    // o solo como det.idProducto (cuando viene del binding del formulario)
                    const idProd = det.producto && det.producto.idproducto
                        ? det.producto.idproducto
                        : det.idProducto;

                    if (!idProd) return;

                    if (!stockMap[idProd]) {
                        stockMap[idProd] = 0;
                    }
                    stockMap[idProd] += cant;
                });
            }

            // Inicializar indicador de cuenta al cargar y al cambiar mesa (con recarga dinámica)
            document.addEventListener('DOMContentLoaded', function() {
                const selectMesa = document.getElementById('idMesa');
                if (selectMesa) {
                    selectMesa.addEventListener('change', function() {
                        recargarCuentasAbiertasYActualizar();
                        actualizarResumenMesaCliente();
                    });
                }
                recargarCuentasAbiertasYActualizar();
                actualizarResumenMesaCliente();
            });
            
            function getStock(idProducto) {
                return stockMap[idProducto] || 0;
            }
            let timeoutBusqueda = null;
            
            // Cargar detalles existentes al editar y registrar eventos de la página POS
            document.addEventListener('DOMContentLoaded', function() {
                // Inicializar tooltips de Bootstrap (si está disponible) sin romper el resto del JS
                try {
                    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                    if (typeof bootstrap !== 'undefined' && bootstrap.Tooltip) {
                        tooltipTriggerList.map(function (tooltipTriggerEl) {
                            return new bootstrap.Tooltip(tooltipTriggerEl);
                        });
                    }
                } catch (err) {
                    console.warn('No se pudieron inicializar los tooltips en el POS:', err);
                }
                
                // Cargar cliente existente si hay
                if (clienteIdExistente) {
                    const clienteExistente = clientesData.find(c => c.idcliente === clienteIdExistente);
                    if (clienteExistente) {
                        document.getElementById('clienteBusqueda').value = clienteExistente.nombre;
                        document.getElementById('clienteSeleccionado').textContent = '✓ ' + clienteExistente.nombre;
                    }
                }
                
                if (detallesExistentes && detallesExistentes.length > 0) {
                    detallesExistentes.forEach(det => {
                        let idProd = null;
                        let nombre = '';
                        let precioUnitario = det.precioUnitario != null ? det.precioUnitario : 0;

                        if (det.producto) {
                            // Caso cuando el backend envía el producto embebido
                            idProd = det.producto.idproducto;
                            nombre = det.producto.nombre;
                            if (!precioUnitario && det.producto.precio != null) {
                                precioUnitario = det.producto.precio;
                            }
                        } else if (det.idProducto) {
                            // Caso cuando solo viene el idProducto desde el formulario
                            idProd = det.idProducto;
                            const producto = productosData.find(p => p.idproducto === idProd);
                            if (producto) {
                                nombre = producto.nombre;
                                if (!precioUnitario && producto.precio != null) {
                                    precioUnitario = producto.precio;
                                }
                            } else {
                                nombre = 'Producto #' + idProd;
                            }
                        }

                        if (!idProd) return;

                        const productoBase = productosData.find(p => p.idproducto === idProd);
                        carrito.push({
                            id: idProd,
                            nombre: nombre,
                            precio: precioUnitario,
                            cantidad: det.cantidad,
                            stockDisponible: productoBase ? productoBase.stockActual : 999
                        });
                    });
                    renderizarCarrito();
                }
                
                // Event listeners para filtros de categoría
                document.querySelectorAll('.btn-categoria').forEach(btn => {
                    btn.addEventListener('click', function() {
                        document.querySelectorAll('.btn-categoria').forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                        filtrarPorCategoria(this.dataset.categoria);
                    });
                });
                
                // Búsqueda de cliente
                const inputCliente = document.getElementById('clienteBusqueda');
                inputCliente.addEventListener('input', function() {
                    clearTimeout(timeoutBusqueda);
                    const termino = this.value.trim();
                    
                    if (termino.length < 2) {
                        document.getElementById('clienteResultados').style.display = 'none';
                        return;
                    }
                    
                    timeoutBusqueda = setTimeout(() => buscarClientes(termino), 300);
                    actualizarResumenMesaCliente();
                });

                // Verificar pedidos activos al cambiar de mesa
                const selectMesa = document.getElementById('idMesa');
                if (selectMesa) {
                    selectMesa.addEventListener('change', function() {
                        if (this.value) {
                            verificarPedidosMesa(this.value);
                        }
                    });
                }

                const rbNueva = document.getElementById('modoCuentaNueva');
                if (rbNueva) {
                    rbNueva.addEventListener('change', function() {
                        if (this.checked) {
                            const inputId = document.getElementById('idCuentaSeleccionada');
                            if (inputId) {
                                inputId.value = '';
                            }
                            const lista = document.getElementById('listaCuentasMesa');
                            if (lista) {
                                lista.querySelectorAll('.list-group-item').forEach(el => el.classList.remove('active'));
                            }
                        }
                    });
                }

                const rbExistente = document.getElementById('modoCuentaExistente');
                if (rbExistente) {
                    rbExistente.addEventListener('change', function() {
                        if (this.checked) {
                            actualizarInfoCuentaMesa();
                        }
                    });
                }

                // Búsqueda de productos en el panel
                const inputProducto = document.getElementById('busquedaProducto');
                if (inputProducto) {
                    inputProducto.addEventListener('input', function() {
                        terminoProducto = this.value.trim();
                        aplicarFiltrosProductos();
                    });
                }
                
                // Cerrar resultados al hacer clic fuera
                document.addEventListener('click', function(e) {
                    if (!e.target.closest('#clienteBusqueda') && !e.target.closest('#clienteResultados')) {
                        document.getElementById('clienteResultados').style.display = 'none';
                    }
                });
            });

            // Validación del formulario POS al enviar
            function validarYEnviarPedido(e) {
                const idMesa = document.getElementById('idMesa')?.value;
                const idCliente = document.getElementById('idCliente')?.value;
                const btnGuardar = document.getElementById('btnGuardar');

                if (!idMesa || idMesa === '') {
                    if (e) e.preventDefault();
                    mostrarErrorPos('Debe seleccionar una mesa para continuar');
                    document.getElementById('idMesa')?.focus();
                    return false;
                }

                if (!idCliente || idCliente === '') {
                    if (e) e.preventDefault();
                    mostrarErrorPos('Debe seleccionar un cliente para continuar');
                    document.getElementById('clienteBusqueda')?.focus();
                    return false;
                }

                if (!carrito || carrito.length === 0) {
                    if (e) e.preventDefault();
                    mostrarErrorPos('Debe agregar al menos un producto al pedido');
                    return false;
                }

                // Validar que ningún producto exceda el stock
                for (const item of carrito) {
                    const stockDisponible = getStock(item.id);
                    if (item.cantidad > stockDisponible) {
                        if (e) e.preventDefault();
                        mostrarErrorPos('El producto "' + item.nombre + '" excede el stock disponible. Stock: ' + stockDisponible + ', Cantidad: ' + item.cantidad);
                        return false;
                    }
                }

                // Si todo está correcto, dejamos que el navegador envíe normalmente el formulario
                // así se respeta el botón que disparó el submit (por ejemplo, accion=AGREGAR_CUENTA)
                if (btnGuardar && e && e.submitter === btnGuardar) {
                    btnGuardar.disabled = true;
                    btnGuardar.innerHTML = '<i class="bi bi-hourglass-split"></i> Enviando...';
                }

                return true;
            }
            
            function buscarClientes(termino) {
                // Buscar en servidor vía API
                fetch('/api/pos/clientes/buscar?termino=' + encodeURIComponent(termino))
                    .then(r => r.ok ? r.json() : [])
                    .then(resultados => mostrarResultadosCliente(resultados, termino))
                    .catch(() => {
                        // Fallback: buscar en datos locales si la API falla
                        const resultados = clientesData.filter(c => 
                            c.nombre.toLowerCase().includes(termino.toLowerCase()) ||
                            (c.cedula && c.cedula.includes(termino))
                        );
                        mostrarResultadosCliente(resultados, termino);
                    });
            }
            
            function mostrarResultadosCliente(resultados, termino) {
                const container = document.getElementById('clienteResultados');
                
                if (resultados.length === 0) {
                    container.innerHTML = `
                        <div class="list-group-item text-muted">
                            No se encontró "<strong>${termino}</strong>"
                            <button type="button" class="btn btn-sm btn-success float-end" onclick="abrirModalNuevoCliente('${termino}')">
                                <i class="bi bi-plus"></i> Crear
                            </button>
                        </div>
                    `;
                } else {
                    container.innerHTML = resultados.map(c => `
                        <button type="button" class="list-group-item list-group-item-action" onclick="seleccionarCliente(${c.idcliente}, '${c.nombre}')">
                            <strong>${c.nombre}</strong>
                            ${c.cedula ? '<small class="text-muted ms-2"><i class="bi bi-credit-card-2-front"></i> ' + c.cedula + '</small>' : ''}
                        </button>
                    `).join('');
                }
                
                container.style.display = 'block';
            }

            function verificarPedidosMesa(idMesa) {
                fetch('/api/pos/mesas/' + idMesa + '/pedidos-activos')
                    .then(r => r.json())
                    .then(data => {
                        if (!Array.isArray(data) || data.length === 0) {
                            return;
                        }
                        const cont = document.getElementById('listaPedidosMesa');
                        let html = '<div class="table-responsive"><table class="table table-sm table-hover align-middle"><thead><tr>' +
                                   '<th>ID</th><th>Fecha</th><th>Cliente</th><th>Total</th><th>Estado</th><th>Acciones</th>' +
                                   '</tr></thead><tbody>';
                        data.forEach(p => {
                            const fecha = p.fecha ? new Date(p.fecha).toLocaleString() : '';
                            const cliente = p.cliente && p.cliente.nombre ? p.cliente.nombre : '-';
                            const total = (p.total ?? 0).toFixed ? p.total.toFixed(2) : p.total;
                            html += '<tr>' +
                                    '<td>#' + p.idpedido + '</td>' +
                                    '<td>' + fecha + '</td>' +
                                    '<td>' + cliente + '</td>' +
                                    '<td>$' + (total || '0.00') + '</td>' +
                                    '<td><span class="badge ' + (p.estado === 'PENDIENTE' ? 'bg-warning text-dark' : p.estado === 'EN_COCINA' ? 'bg-primary' : p.estado === 'LISTO_PARA_ENTREGA' ? 'bg-info text-dark' : p.estado === 'COMPLETADO' ? 'bg-success' : 'bg-secondary') + '">' + (p.estado === 'LISTO_PARA_ENTREGA' ? 'POR ENTREGAR' : p.estado) + '</span></td>' +
                                    '<td>' +
                                        '<a href="/pedidos/editar/' + p.idpedido + '" class="btn btn-sm btn-outline-primary me-1">Abrir</a>' +
                                        '<a href="/pedidos/detalle/' + p.idpedido + '" class="btn btn-sm btn-outline-secondary me-1">Detalle</a>' +
                                        (p.estado === 'PENDIENTE' ? '<button type="button" class="btn btn-sm btn-outline-warning" onclick="enviarACocinaAjax(' + p.idpedido + ')"><i class="bi bi-fire"></i> Cocina</button>' : '') +
                                    '</td>' +
                                    '</tr>';
                        });
                        html += '</tbody></table></div>';
                        cont.innerHTML = html;
                        const modal = new bootstrap.Modal(document.getElementById('modalPedidosMesa'));
                        modal.show();
                    })
                    .catch(err => console.error('Error al cargar pedidos de mesa', err));
            }
            
            function seleccionarCliente(id, nombre) {
                document.getElementById('idCliente').value = id;
                document.getElementById('clienteBusqueda').value = nombre;
                document.getElementById('clienteSeleccionado').textContent = '✓ ' + nombre;
                document.getElementById('clienteResultados').style.display = 'none';
                actualizarResumenMesaCliente();
            }
            
            function abrirModalNuevoCliente(nombreInicial = '') {
                document.getElementById('nuevoClienteNombre').value = nombreInicial;
                document.getElementById('nuevoClienteCedula').value = '';
                document.getElementById('nuevoClienteTelefono').value = '';
                document.getElementById('nuevoClienteDireccion').value = '';
                document.getElementById('nuevoClienteEmail').value = '';
                new bootstrap.Modal(document.getElementById('modalNuevoCliente')).show();
            }
            
            function guardarNuevoCliente() {
                const nombre = document.getElementById('nuevoClienteNombre').value.trim();
                const cedula = document.getElementById('nuevoClienteCedula').value.trim();
                const telefono = document.getElementById('nuevoClienteTelefono').value.trim();
                
                if (!nombre) {
                    alert('El nombre es obligatorio');
                    return;
                }
                // Cédula: 10-13 dígitos numéricos
                if (!/^[0-9]{10,13}$/.test(cedula)) {
                    alert('La cédula es obligatoria y debe tener entre 10 y 13 dígitos numéricos');
                    return;
                }

                // Validar cédula duplicada en datos locales
                const cedulaDuplicada = clientesData.some(c => c.cedula === cedula);
                if (cedulaDuplicada) {
                    alert('Ya existe un cliente registrado con esa cédula');
                    return;
                }

                // Teléfono: opcional; si se ingresa, debe tener exactamente 10 dígitos numéricos
                if (telefono && !/^[0-9]{10}$/.test(telefono)) {
                    alert('Si ingresa teléfono, debe tener exactamente 10 dígitos numéricos');
                    return;
                }
                
                const cliente = {
                    nombre: nombre,
                    cedula: cedula,
                    telefono: telefono,
                    direccion: document.getElementById('nuevoClienteDireccion').value.trim(),
                    email: document.getElementById('nuevoClienteEmail').value.trim(),
                    estado: true
                };
                
                fetch('/api/pos/clientes/crear-rapido', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': csrfToken
                    },
                    body: JSON.stringify(cliente)
                })
                .then(response => response.json())
                .then(nuevoCliente => {
                    // Agregar a la lista local
                    clientesData.push(nuevoCliente);
                    
                    // Seleccionar el nuevo cliente
                    seleccionarCliente(nuevoCliente.idcliente, nuevoCliente.nombre);
                    
                    // Cerrar modal
                    bootstrap.Modal.getInstance(document.getElementById('modalNuevoCliente')).hide();
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error al crear el cliente');
                });
            }
            
            function aplicarFiltrosProductos() {
                const termino = terminoProducto.trim().toLowerCase();
                document.querySelectorAll('.producto-card').forEach(card => {
                    const nombre = (card.dataset.nombre || '').toLowerCase();
                    const categoriaId = card.dataset.categoria;
                    const coincideCategoria = categoriaSeleccionada === 'todos' || categoriaId == categoriaSeleccionada;
                    const coincideNombre = !termino || nombre.includes(termino);
                    card.style.display = coincideCategoria && coincideNombre ? 'flex' : 'none';
                });
            }

            function irAObservaciones() {
                const textarea = document.querySelector('textarea[name="observaciones"]');
                if (textarea) {
                    textarea.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    setTimeout(() => textarea.focus(), 300);
                }
            }

            function filtrarPorCategoria(categoriaId) {
                categoriaSeleccionada = categoriaId;
                aplicarFiltrosProductos();
            }
            
            function agregarAlCarrito(element) {
                const id = parseInt(element.dataset.id);
                const nombre = element.dataset.nombre;
                const precio = parseFloat(element.dataset.precio);
                const stockDisponible = getStock(id);
                
                // Verificar si hay stock disponible
                if (stockDisponible <= 0) {
                    alert('El producto "' + nombre + '" está agotado (Stock: 0)');
                    return;
                }
                
                // Buscar si ya existe en el carrito
                const existente = carrito.find(item => item.id === id);
                
                if (existente) {
                    // Verificar que no se exceda el stock disponible
                    if (existente.cantidad >= stockDisponible) {
                        alert('Stock insuficiente para "' + nombre + '". Disponible: ' + stockDisponible + ', En carrito: ' + existente.cantidad);
                        return;
                    }
                    existente.cantidad++;
                } else {
                    if (1 > stockDisponible) {
                        alert('Stock insuficiente para "' + nombre + '". Disponible: ' + stockDisponible);
                        return;
                    }
                    carrito.push({ id, nombre, precio, cantidad: 1 });
                }
                
                renderizarCarrito();
                
                // Efecto visual de agregado
                element.classList.add('producto-agregado');
                setTimeout(() => element.classList.remove('producto-agregado'), 300);
            }
            
            function cambiarCantidad(id, delta) {
                const item = carrito.find(i => i.id === id);
                if (item) {
                    const nuevaCantidad = item.cantidad + delta;
                    
                    // Si es incremento, validar stock
                    if (delta > 0) {
                        const stockDisponible = getStock(id);
                        if (nuevaCantidad > stockDisponible) {
                            alert('Stock insuficiente para "' + item.nombre + '". Disponible: ' + stockDisponible);
                            return;
                        }
                    }
                    
                    item.cantidad = nuevaCantidad;
                    if (item.cantidad <= 0) {
                        carrito = carrito.filter(i => i.id !== id);
                    }
                }
                renderizarCarrito();
            }
            
            function eliminarDelCarrito(id) {
                carrito = carrito.filter(i => i.id !== id);
                renderizarCarrito();
            }
            
            function limpiarCarrito() {
                carrito = [];
                renderizarCarrito();
            }
            
            function renderizarCarrito() {
                const container = document.getElementById('carritoItems');
                const hiddenContainer = document.getElementById('detallesHidden');
                const vacioMsg = document.getElementById('carritoVacio');
                const btnGuardar = document.getElementById('btnGuardar');
                const badgeItems = document.getElementById('badgeItems');
                
                if (carrito.length === 0) {
                    container.innerHTML = `
                        <div class="carrito-vacio" id="carritoVacio">
                            <i class="bi bi-cart-x"></i>
                            <p>Carrito vacío</p>
                            <small>Haz clic en un producto para agregarlo</small>
                        </div>
                    `;
                    hiddenContainer.innerHTML = '';
                    btnGuardar.disabled = true;
                    document.getElementById('totalPedido').textContent = '$0.00';
                    if (badgeItems) {
                        badgeItems.textContent = '0 ítems';
                    }
                    return;
                }
                
                btnGuardar.disabled = false;
                let html = '';
                let hiddenHtml = '';
                let total = 0;
                
                carrito.forEach((item, index) => {
                    const subtotal = item.precio * item.cantidad;
                    total += subtotal;
                    
                    // Obtener stock del producto usando función segura
                    const stockDisponible = getStock(item.id);
                    const stockWarning = item.cantidad >= stockDisponible ? ' text-danger' : '';
                    
                    const seleccionadoClass = '';
                    html += `
                        <div class="carrito-item">
                            <div class="carrito-item-info">
                                <span class="carrito-item-nombre">${item.nombre}</span>
                                <span class="carrito-item-precio">$${item.precio.toFixed(2)} c/u</span>
                                ${stockDisponible <= 5 ? `<small class="text-warning"><i class="bi bi-exclamation-triangle"></i> Stock: ${stockDisponible}</small>` : ''}
                            </div>
                            <div class="carrito-item-acciones">
                                <div class="carrito-item-cantidad">
                                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="cambiarCantidad(${item.id}, -1)">
                                        <i class="bi bi-dash"></i>
                                    </button>
                                    <span class="cantidad-valor${stockWarning}">${item.cantidad}</span>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="cambiarCantidad(${item.id}, 1)" ${item.cantidad >= stockDisponible ? 'disabled' : ''}>
                                        <i class="bi bi-plus"></i>
                                    </button>
                                </div>
                                <div class="carrito-item-subtotal">
                                    <span>$${subtotal.toFixed(2)}</span>
                                    <button type="button" class="btn btn-sm btn-link text-danger" onclick="eliminarDelCarrito(${item.id})">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Inputs hidden para el form
                    hiddenHtml += `
                        <input type="hidden" name="detalles[${index}].idProducto" value="${item.id}" />
                        <input type="hidden" name="detalles[${index}].cantidad" value="${item.cantidad}" />
                        <input type="hidden" name="detalles[${index}].precioUnitario" value="${item.precio}" />
                    `;
                });
                
                container.innerHTML = html;
                hiddenContainer.innerHTML = hiddenHtml;
                document.getElementById('totalPedido').textContent = '$' + total.toFixed(2);
                if (badgeItems) {
                    const count = carrito.length;
                    badgeItems.textContent = count + ' ítem' + (count === 1 ? '' : 's');
                }
            }

            // === Enviar pedido a cocina vía AJAX ===
            function enviarACocinaAjax(idPedido) {
                if (!confirm('¿Enviar pedido #' + idPedido + ' a cocina?')) return;
                fetch('/api/pos/pedidos/' + idPedido + '/estado', {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': csrfToken
                    },
                    body: JSON.stringify({ estado: 'EN_COCINA' })
                })
                .then(r => r.json())
                .then(data => {
                    if (data.error) {
                        alert('Error: ' + data.error);
                    } else {
                        alert('Pedido #' + idPedido + ' enviado a cocina');
                        // Recargar la página para reflejar el cambio
                        window.location.href = '/pedidos/nuevo';
                    }
                })
                .catch(err => {
                    console.error('Error al enviar a cocina:', err);
                    alert('Error al enviar a cocina');
                });
            }

            // === Refrescar stock de productos desde el servidor ===
            function refrescarStock() {
                fetch('/api/pos/productos/activos')
                    .then(r => r.ok ? r.json() : [])
                    .then(productos => {
                        if (!Array.isArray(productos) || productos.length === 0) return;
                        // Actualizar stockMap
                        productos.forEach(p => {
                            stockMap[p.idproducto] = (p.stockActual != null && p.stockActual > 0) ? p.stockActual : 0;
                        });
                        // Actualizar las tarjetas de producto en el DOM
                        document.querySelectorAll('.producto-card').forEach(card => {
                            const id = parseInt(card.dataset.id);
                            const prod = productos.find(p => p.idproducto === id);
                            if (!prod) return;
                            const stock = (prod.stockActual != null && prod.stockActual > 0) ? prod.stockActual : 0;
                            card.dataset.stock = stock;
                            card.dataset.precio = prod.precio;
                            // Actualizar clases de stock
                            card.classList.remove('producto-agotado', 'producto-stock-bajo');
                            if (stock === 0) card.classList.add('producto-agotado');
                            else if (stock <= 5) card.classList.add('producto-stock-bajo');
                            // Actualizar badges
                            const badges = card.querySelectorAll('.badge.position-absolute');
                            badges.forEach(b => b.remove());
                            const imgDiv = card.querySelector('.producto-img');
                            if (imgDiv) {
                                if (stock === 0) {
                                    imgDiv.insertAdjacentHTML('beforeend', '<span class="badge bg-danger position-absolute top-0 start-0 m-1">AGOTADO</span>');
                                } else if (stock <= 5) {
                                    imgDiv.insertAdjacentHTML('beforeend', '<span class="badge bg-warning position-absolute top-0 start-0 m-1">Stock: ' + stock + '</span>');
                                }
                            }
                            // Actualizar precio
                            const precioElem = card.querySelector('.producto-precio');
                            if (precioElem) precioElem.textContent = '$' + prod.precio.toFixed(2);
                        });
                        // Re-renderizar carrito con nuevo stock
                        if (carrito.length > 0) renderizarCarrito();
                        console.log('Stock actualizado:', new Date().toLocaleTimeString());
                    })
                    .catch(err => console.error('Error al refrescar stock:', err));
            }

            // === Cargar ventas del día en el header ===
            function cargarVentasHoy() {
                fetch('/api/pos/ventas-hoy')
                    .then(r => r.ok ? r.json() : {})
                    .then(data => {
                        const ventasTxt = document.getElementById('ventasHoyTexto');
                        const pedidosTxt = document.getElementById('pedidosHoyTexto');
                        if (ventasTxt) ventasTxt.textContent = '$' + (data.totalVentas || 0).toFixed(2);
                        if (pedidosTxt) pedidosTxt.textContent = '(' + (data.numeroPedidos || 0) + ' pedidos)';
                    })
                    .catch(err => console.error('Error al cargar ventas:', err));
            }

            // Refrescar stock y ventas cada 30 segundos
            setInterval(refrescarStock, 30000);
            setInterval(cargarVentasHoy, 60000);
            // Cargar al inicio
            document.addEventListener('DOMContentLoaded', function() {
                cargarVentasHoy();
                refrescarStock();
            });
        </script>
    </div>
</body>
</html>
